# docker-compose.yml
services:
  redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  broke-server:
    restart: always
    image: ghcr.io/valteryde/broke:latest
    # To build from source instead, comment out 'image' and uncomment 'build':
    # build: .
    ports:
      - "127.0.0.1:8080:8080"
    volumes:
      - data:/data
    environment:
      - DATA_PATH=/data
      - REDIS_URL=redis://redis:6379
      - UPDATER_URL=http://broke-updater:9999
    depends_on:
      - redis

  broke-updater:
    build: ./updater
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - COMPOSE_PROJECT=broke
      - TARGET_SERVICE=broke-server
      - TARGET_IMAGE=ghcr.io/valteryde/broke:latest

volumes:
  data:
  redis_data:
