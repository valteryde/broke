{% extends "dashboard.jinja2" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dropdown.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ticket.css') }}">
    <!-- Quill.js -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block path %}
    <a href="/tickets"><i class="ph ph-ticket"></i> Tickets</a> <i class="ph ph-caret-right"></i> <a href="/tickets/{{ project.id }}"><i class="{{ project.icon }}"></i> {{ project.name }}</a>  <i class="ph ph-caret-right"></i> <a href="/tickets/{{ project.id }}/{{ ticket.id }}"><i class="ph ph-pen"></i> {{ ticket.id }}</a> 
{% endblock %}

{% block content %}

<div id="ticket-editor"></div>

{% endblock %}

{% block scripts %}
    <!-- Quill.js -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <!-- Dropdown component -->
    <script src="{{ url_for('static', filename='js/dropdown.js') }}"></script>
    <!-- Ticket editor -->
    <script src="{{ url_for('static', filename='js/ticket.js') }}"></script>
    
    <script>

        var editor;
        document.addEventListener('DOMContentLoaded', () => {
            // Sample ticket data (would come from backend)
            const ticketData = {
                id: '{{ ticket.id }}',
                title: '{{ ticket.title }}',
                description: `{{ ticket.description.replace("`", "\\`").replace("\n", "\\n") | default("<p>No description yet.</p>", true) | safe }}`,
                status: '{{ ticket.status | default("todo", true) }}',
                priority: '{{ ticket.priority | default("medium", true) }}',
                error: { {% if ticket.error %}
                    id: '{{ ticket.error.id }}',
                    part: '{{ ticket.error.part.id }}',
                    project: '{{ ticket.error.part.project.id }}'
                {% else %}
                    id: null,
                    part: null,
                    project: null
                {% endif %}},
                labels: [
                    {% for label in ticket.labels %}
                    {
                        id: '{{ label.id }}',
                        name: '{{ label.name }}',
                        color: '{{ label.color }}'
                    },
                    {% endfor %}
                ],
                assignees: [
                    {% for assignee in ticket.assignees %}
                    {
                        id: '{{ assignee.username }}',
                        username: '{{ assignee.username }}',
                        avatar: null
                    },
                    {% endfor %}
                ],
                dueDate: '{{ ticket.due_date | default("", true) }}'
            };
            
            // Current user (would come from session)
            const currentUser = {
                id: '{{ user.username }}',
                username: '{{ user.username }}',
                avatar: null
            };
            
            // Sample activity (would come from backend)
            const activityData = [
                {% for comment in comments %}
                {
                    id: '{{ comment.id }}',
                    author: {
                        id: '{{ comment.user.username }}',
                        username: '{{ comment.user.username }}',
                        avatar: "<svg width='40' height='40' data-jdenticon-value='{{ comment.user.username }}'></svg>"
                    },
                    type: 'comment',
                    content: `{{ comment.body | default("", true) | safe }}`,
                    createdAt: {{ comment.created_at }} * 1000
                },
                {% endfor %}
                {% for update in updates %}
                {
                    id: '{{ update.id }}',
                    message : `{{ update.message | default("", true) | safe }}`,
                    icon : 'ph-ph-{{ update.icon }}',
                    createdAt: {{ update.created_at }} * 1000,
                    type: 'update'
                    // ticket = CharField()
                    // title = CharField()
                    // icon = CharField()
                    // message = CharField()
    
                },
                {% endfor %}
            ]
            
            // Available options for dropdowns
            const availableUsers = [
                {% for available_user in available_users %} 
                {
                    id: '{{ available_user.username }}',
                    username: '{{ available_user.username }}',
                },
                {% endfor %}
            ]
            
            const availableLabels = [
                {% for available_label in available_labels %}
                {
                    id: '{{ available_label.name }}',
                    name: '{{ available_label.name }}',
                    color: '{{ available_label.color }}'
                },
                {% endfor %}
            ]

            // Initialize ticket editor
            editor = new TicketEditor('ticket-editor', {
                ticket: ticketData,
                currentUser: currentUser,
                activity: activityData,
                availableUsers: availableUsers,
                availableLabels: availableLabels,
                
                // Save callback - POST to backend
                onSave: async (field, value, oldValue) => {
                    console.log('Saving:', field, value);
                    try {
                        const response = await fetch('/api/tickets/{{ ticket.id }}', {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ field, value, oldValue })
                        });
                        
                        if (!response.ok) {
                            console.error('Failed to save:', await response.json());
                        }
                    } catch (error) {
                        console.error('Save error:', error);
                    }
                },
                
                // Comment callback - POST to backend
                onComment: async (content, comment) => {
                    console.log('New comment:', content);
                    try {
                        const response = await fetch('/api/tickets/{{ ticket.id }}/comments', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            // Update comment with real ID from server
                            comment.id = data.comment.id;
                        } else {
                            console.error('Failed to add comment:', await response.json());
                        }
                    } catch (error) {
                        console.error('Comment error:', error);
                    }
                },
                
                // Delete comment callback
                onDeleteComment: async (commentId) => {
                    console.log('Delete comment:', commentId);
                    try {
                        const response = await fetch(`/api/comments/${commentId}`, { 
                            method: 'DELETE' 
                        });
                        
                        if (!response.ok) {
                            console.error('Failed to delete comment:', await response.json());
                        }
                    } catch (error) {
                        console.error('Delete comment error:', error);
                    }
                },
                
                // Edit comment callback
                onEditComment: (commentId, currentContent) => {
                    console.log('Edit comment:', commentId);
                    // Could open a modal or inline editor
                }
            });
        });
    </script>
{% endblock %}