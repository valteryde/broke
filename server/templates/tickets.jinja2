{% extends "dashboard.jinja2" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/board.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dropdown.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lists.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
{% endblock %}

{% block content %}

<h1>Tickets</h1>

<div class="project-tabs" id="project-tabs">
    <button class="project-tab {% if not project %}active{% endif %}" data-project="all" onclick="window.location.href = '/tickets'">
        <i class="ph ph-squares-four"></i> All
    </button>
    <!-- Project tabs will be populated dynamically -->

    {% for proj in projects %}
    <button class="project-tab {% if proj.id == project.id %}active{% endif %}" data-project="{{ proj.id }}" onclick="window.location.href = '/tickets/{{ proj.id }}' ">
        <i class="{{ proj.icon }}"></i> {{ proj.name }}
    </button>
    {% endfor %}

</div>

<div id="ticket-list"></div>

{% endblock %}

{% block path %}
    <a href="/tickets"><i class="ph ph-ticket"></i> Tickets</a> {% if project %} <i class="ph ph-caret-right"></i> <a href="/tickets/{{ project.id }}"><i class="{{ project.icon }}"></i> {{ project.name }}</a> {% endif %}
{% endblock %}

{% block scripts %}

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="{{ url_for('static', filename='js/dropdown.js') }}"></script>
    <script src="{{ url_for('static', filename='js/lists.js') }}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ticketList = new List('ticket-list', {
                filters: {
                    search: { placeholder: 'Search tickets...' },
                    labels: { label: 'Labels' },
                    assignees: { label: 'Assignees' },
                    urgency: { label: 'Urgency' },
                    dateRange: { label: 'Date' }
                },
                groupBy: {
                    options: ['none', 'urgency', 'assignees', 'labels'],
                    default: 'none'
                }
            });

            const tickets = [
                {% for ticket in tickets %}
                {
                    id: '{{ ticket.id }}',
                    title: '{{ ticket.title }}',
                    description: '{{ ticket.description | default("No description provided.", true) | safe }}',
                    icon: 'ph-cell-signal-{{ "high" if ticket.priority == "high" else "medium" if ticket.priority == "medium" else "low" }}',
                    urgency: '{{ ticket.priority }}',
                    labels: [
                        {% for label in ticket.labels %}
                        {text: '{{ label.name }}', color: '{{ label.color }}'},
                        {% endfor %}
                    ],
                    assignees: [
                        {% for assignee in ticket.assignees %}
                        '{{ assignee }}',
                        {% endfor %}
                    ],
                    createdAt: '{{ ticket.created_at }}',
                    project: '{{ ticket.project }}',
                    onClick: () => { window.location.href = '/tickets/{{ ticket.project }}/{{ ticket.id }}'; }
                },
                {% endfor %}
            ];

            tickets.forEach(ticket => ticketList.add(ticket));
        });
    </script>

{% endblock %}
