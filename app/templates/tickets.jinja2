{% extends "dashboard.jinja2" %}

{% block title %}Tickets | Broke{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dropdown.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lists.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">

    <script>
    window.availableUsers = [
        {% for available_user in available_users %} 
        {
            id: '{{ available_user.username }}',
            username: '{{ available_user.username }}',
        },
        {% endfor %}
    ];

    window.availableLabels = [
        {% for available_label in available_labels %} 
        {
            id: '{{ available_label.name }}',
            name: '{{ available_label.name }}',
            color: '{{ available_label.color }}'
        },
        {% endfor %}
    ];

    </script>


{% endblock %}

{% block content %}

<h1>Tickets</h1>

<div class="project-tabs" id="project-tabs">
    <button class="project-tab {% if not project %}active{% endif %}" data-project="all" onclick="openUrlWithArgs('/tickets')">
        <i class="ph ph-squares-four"></i> All
    </button>
    <!-- Project tabs will be populated dynamically -->

    {% for proj in projects %}
    <button class="project-tab {% if proj.id == project.id %}active{% endif %}" data-project="{{ proj.id }}" onclick="openUrlWithArgs('/tickets/{{ proj.id }}')">
        <i class="{{ proj.icon }}"></i> {{ proj.name }}
    </button>
    {% endfor %}

</div>

<div id="ticket-list"></div>

{% endblock %}

{% block path %}
    <a href="#" onclick="openUrlWithArgs('/tickets'); return false;"><i class="ph ph-ticket"></i> Tickets</a> {% if project %} <i class="ph ph-caret-right"></i> <a href="#" onclick="openUrlWithArgs('/tickets/{{ project.id }}'); return false;"><i class="{{ project.icon }}"></i> {{ project.name }}</a> {% endif %}
{% endblock %}

{% block scripts %}

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dropdown.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ticket_list.js') }}"></script>
    <script src="{{ url_for('static', filename='js/lists.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/list_modal.js') }}"></script>
    
    
    <script>
        // Available projects for ticket creation modal
        const availableProjects = [
            {% for proj in projects %}
            {
                id: '{{ proj.id }}',
                name: '{{ proj.name }}',
                icon: '{{ proj.icon }}',
                color: '{{ proj.color }}'
            },
            {% endfor %}
        ];

        // Available options for dropdowns (globals for List/Shortcuts to use)
        window.availableUsers = [
            {% for available_user in available_users %} 
            {
                id: '{{ available_user.username }}',
                username: '{{ available_user.username }}',
            },
            {% endfor %}
        ];
        
        window.availableLabels = [
            {% for available_label in available_labels %}
            {
                id: '{{ available_label.name }}',
                name: '{{ available_label.name }}',
                color: '{{ available_label.color }}'
            },
            {% endfor %}
        ];

        // Show create ticket modal
        function showCreateTicketModal() {
            let selectedProject = {% if project %}'{{ project.id }}'{% else %}null{% endif %};
            
            const projectItems = availableProjects.map(proj => `
                <div class="modal-project-item ${selectedProject === proj.id ? 'selected' : ''}" 
                     data-project-id="${proj.id}"
                     onclick="selectProject('${proj.id}')">
                    <i class="${proj.icon}"></i>
                    <span class="modal-project-item-name">${proj.name}</span>
                    <span class="modal-project-item-id">${proj.id}</span>
                </div>
            `).join('');
            
            Modal.show('Create New Ticket', `
                <div class="form-group">
                    <label>Select Project</label>
                    <div class="modal-project-list" id="project-list">
                        ${projectItems}
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="Modal.close()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="create-ticket-btn" onclick="createTicket()">
                        Create Ticket
                    </button>
                </div>
            `);
            
            // Store selected project in window for access by createTicket
            window.selectedProjectId = selectedProject;
            updateCreateButton();
        }
        
        // Select project in modal
        function selectProject(projectId) {
            window.selectedProjectId = projectId;
            
            // Update UI
            document.querySelectorAll('.modal-project-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.projectId === projectId);
            });
            
            updateCreateButton();
        }
        
        // Update create button state
        function updateCreateButton() {
            const btn = document.getElementById('create-ticket-btn');
            if (btn) {
                btn.disabled = !window.selectedProjectId;
            }
        }
        
        // Create ticket and redirect
        async function createTicket() {
            if (!window.selectedProjectId) return;
            
            const btn = document.getElementById('create-ticket-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="ph ph-circle-notch" style="animation: spin 1s linear infinite;"></i> Creating...';
            }
            
            try {
                const response = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        project: window.selectedProjectId,
                        title: '',
                        status: 'backlog',
                        priority: 'medium'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    Modal.close();
                    // Redirect to new ticket
                    window.location.href = `/tickets/${data.ticket.project}/${data.ticket.id}`;
                } else {
                    const error = await response.json();
                    alert('Failed to create ticket: ' + (error.error || 'Unknown error'));
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = 'Create Ticket';
                    }
                }
            } catch (error) {
                console.error('Create ticket error:', error);
                alert('Failed to create ticket');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Create Ticket';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const ticketList = new List('ticket-list', {
                ...TicketListConfig, // Spread base config
                groupBy: {
                    ...TicketListConfig.groups,
                    default: '{{ group }}' || 'none'
                },
                defaultGroupBy: '{{ group }}' || 'none',
                onCreate: () => {
                    showCreateTicketModal();
                },
                onUpdate: async (item, field, value, isToggle) => {
                     let backendField = field;
                     let backendValue = value;
                     
                     if (field === 'priority') backendField = 'priority';

                     if (field === 'assignees') {
                         backendField = 'assignees';
                         // Map strings back to objects
                         backendValue = item.assignees.map(u => {
                             const user = window.availableUsers.find(au => au.username === u);
                             return user ? { username: user.username, id: user.id } : { username: u };
                         });
                     }
                     
                     if (field === 'labels') {
                         backendValue = item.labels.map(l => ({ name: l.text, color: l.color }));
                     }

                     try {
                        const response = await fetch(`/api/tickets/${item.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ field: backendField, value: backendValue })
                        });
                        
                        if (!response.ok) {
                            showToast('Failed to save changes', 'error');
                        } else {
                            showToast('Updated ' + field, 'success');
                        }
                    } catch (error) {
                        console.error('Save error:', error);
                        showToast('Error saving changes', 'error');
                    }
                },
                onDelete: async (item) => {
                    try {
                        const response = await fetch(`/api/tickets/${item.id}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            ticketList.remove(item.id);
                            showToast('Ticket deleted', 'success');
                        } else {
                            showToast('Failed to delete ticket', 'error');
                        }
                    } catch (error) {
                        console.error('Delete error:', error);
                        showToast('Error deleting ticket', 'error');
                    }
                }
            });

            const tickets = [
                {% for ticket in tickets %}
                {
                    id: '{{ ticket.id }}',
                    title: '{{ ticket.title.replace("'", "\\'") | safe }}',
                    description: '{{ ticket.description | safe }}',
                    icon: {% if ticket.priority == "urgent" %}'ph ph-warning'{% else %} 'ph ph-cell-signal-{{ "high" if ticket.priority == "high" else "medium" if ticket.priority == "medium" else "low" if ticket.priority == "low" else "none" }}'{% endif %},
                    status: '{{ ticket.status | default("backlog") }}',
                    urgency: '{{ ticket.priority }}',
                    labels: [
                        {% for label in ticket.labels %}
                        {text: '{{ label.name }}', color: '{{ label.color }}'},
                        {% endfor %}
                    ],
                    assignees: [
                        {% for assignee in ticket.assignees %}
                        '{{ assignee }}',
                        {% endfor %}
                    ],
                    createdAt: '{{ ticket.created_at }}',
                    project: '{{ ticket.project }}',
                    onClick: () => { window.location.href = '/tickets/{{ ticket.project }}/{{ ticket.id }}'; }
                },
                {% endfor %}
            ];

            tickets.forEach(ticket => ticketList.add(ticket));
            
            if ('{{ group }}') {
                ticketList.setGroupBy('{{ group }}');
            }

        });
    </script>

{% endblock %}
