name: Dependency Check

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    paths:
      - 'requirements.txt'
      - 'requirements-test.txt'
      - 'pyproject.toml'

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pip-audit safety
        pip install -r requirements.txt
        
    - name: Audit dependencies with pip-audit
      continue-on-error: true
      run: |
        pip-audit --desc --format json --output pip-audit-report.json || true
        pip-audit --desc
        
    - name: Check for known vulnerabilities with Safety
      continue-on-error: true
      run: |
        safety check --json --output safety-report.json || true
        safety check --short-report
        
    - name: Upload audit reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-audit-reports
        path: |
          pip-audit-report.json
          safety-report.json
          
    - name: Create summary
      if: always()
      run: |
        echo "## Dependency Audit Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### pip-audit" >> $GITHUB_STEP_SUMMARY
        if [ -f pip-audit-report.json ]; then
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat pip-audit-report.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

  outdated-check:
    name: Check for Outdated Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        
    - name: Check for outdated packages
      run: |
        echo "## Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        pip list --outdated >> $GITHUB_STEP_SUMMARY || true
        echo '```' >> $GITHUB_STEP_SUMMARY

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pip-licenses
        pip install -r requirements.txt
        
    - name: Check licenses
      run: |
        echo "## Dependency Licenses" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        pip-licenses --format=markdown >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        
    - name: Check for incompatible licenses
      run: |
        # List of licenses that are generally incompatible with MIT
        INCOMPATIBLE_LICENSES="GPL-3.0|AGPL-3.0|LGPL-3.0"
        
        ISSUES=$(pip-licenses --format=json | jq -r '.[] | select(.License | test("'"$INCOMPATIBLE_LICENSES"'")) | "\(.Name): \(.License)"')
        
        if [ -n "$ISSUES" ]; then
          echo "::warning::Potentially incompatible licenses found:"
          echo "$ISSUES"
        fi
